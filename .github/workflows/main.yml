name: Auto Alt Service Post

on:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch: {}

jobs:
  post:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Add random delay to make timing natural
        run: |
          # Generate random number between -75 and 75 (150 minute range)
          random_minutes=$(( (RANDOM % 151)))
          echo "Random offset: ${random_minutes} minutes"
          
          if [ $random_minutes -lt 0 ]; then
            echo "Negative offset detected. Skipping delay (cannot go back in time)."
            echo "This run will execute immediately at the scheduled time."
          else
            delay_seconds=$(( random_minutes * 60 ))
            echo "Sleeping for ${random_minutes} minutes (${delay_seconds} seconds) to randomize execution time..."
            sleep $delay_seconds
          fi

      - name: Call alt service with retries
        env:
          API_URL: ${{ secrets.ALT_API_URL }}
          POST_TOKEN: ${{ secrets.POST_TOKEN }}
          MAX_ATTEMPTS: 3
          SLEEP_BETWEEN: 10
        run: |
          set -euo pipefail
          if [ -z "${API_URL:-}" ]; then
            echo "ERROR: API_URL secret is not set. Add it in Settings → Secrets and variables → Actions."
            exit 1
          fi
          echo "Calling $API_URL (max attempts: $MAX_ATTEMPTS)"
          attempt=1
          while [ $attempt -le $MAX_ATTEMPTS ]; do
            echo "Attempt $attempt..."
            http_status=$(curl -sS -o /tmp/resp -w "%{http_code}" -X GET \
              -H "accept: application/json" \
              -H "Authorization: Bearer ${POST_TOKEN}" \
              "$API_URL" || true)
            echo "HTTP status: $http_status"
            cat /tmp/resp || true
            # treat 2xx and 3xx as success
            if [ "${http_status:0:1}" = "2" ] || [ "${http_status:0:1}" = "3" ]; then
              echo "Request successful."
              exit 0
            fi
            echo "Request failed with status $http_status."
            attempt=$((attempt + 1))
            if [ $attempt -le $MAX_ATTEMPTS ]; then
              echo "Sleeping ${SLEEP_BETWEEN}s before retry..."
              sleep $SLEEP_BETWEEN
            fi
          done
          echo "All attempts failed. Exiting with non-zero status to mark workflow as failed."
          exit 1
